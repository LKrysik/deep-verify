# Deep-Process v3.6 â€” Registry Schema
# Tracks running process instances and their artifact locations

schema_version: "3.6"
description: |
  Schema for .deep-process/registry.json in user's project.
  This file tracks:
  - Which process instances are running
  - Where their artifacts are stored
  - Current status and progress
  - How to resume/continue each instance

# ============================================================================
# REGISTRY STRUCTURE
# ============================================================================

registry:
  type: object
  required:
    - version
    - created_at
    - last_modified
    - instances
    - active_instance

  properties:
    version:
      type: string
      const: "3.6"
      description: "Deep-Process version"

    created_at:
      type: string
      format: date-time
      description: "When registry was created"

    last_modified:
      type: string
      format: date-time
      description: "Last registry update"

    active_instance:
      type: string
      nullable: true
      description: "Currently active instance_id (for context switching)"

    instances:
      type: array
      items:
        $ref: "#/definitions/instance"
      description: "All process instances"

# ============================================================================
# INSTANCE DEFINITION
# ============================================================================

definitions:
  instance:
    type: object
    required:
      - instance_id
      - process_type
      - process_path
      - artifacts_path
      - status
      - started_at

    properties:
      instance_id:
        type: string
        pattern: "^[a-z0-9-]+$"
        description: |
          Unique identifier for this instance.
          Format: {process-name}-{context}-{sequence}
          Example: onboarding-client-acme-001
        examples:
          - "onboarding-client-acme-001"
          - "code-review-feature-auth-003"
          - "sprint-planning-q1-2025-001"

      process_type:
        type: string
        pattern: "^PROC-[A-Z0-9-]+$"
        description: |
          Reference to process definition in processes/_manifest.yaml
          This links the instance to its SRE-Convergent process definition
        examples:
          - "PROC-ONBOARDING"
          - "PROC-CODE-REVIEW"
          - "PROC-SPRINT-PLANNING"

      process_path:
        type: string
        description: |
          Path to process definition (relative to src/core/deep-process/processes/)
        examples:
          - "onboarding/"
          - "code-review/"

      artifacts_path:
        type: string
        description: |
          Where this instance's artifacts are stored.
          Always under artifacts/processes/{instance_id}/
        examples:
          - "artifacts/processes/onboarding-client-acme-001/"

      status:
        type: string
        enum:
          - PENDING      # Created but not started
          - RUNNING      # Currently active
          - PAUSED       # Suspended, can resume
          - COMPLETED    # Successfully finished
          - FAILED       # Failed with errors
          - ARCHIVED     # Completed and archived
        description: "Current status of the instance"

      started_at:
        type: string
        format: date-time
        description: "When instance was created"

      last_activity:
        type: string
        format: date-time
        description: "Last action on this instance"

      completed_at:
        type: string
        format: date-time
        nullable: true
        description: "When instance completed (if applicable)"

      # Progress tracking
      progress:
        type: object
        properties:
          current_step:
            type: string
            nullable: true
            description: "Current step in the process"

          steps_completed:
            type: array
            items:
              type: string
            description: "List of completed step IDs"

          steps_remaining:
            type: array
            items:
              type: string
            description: "List of remaining step IDs"

          percentage:
            type: number
            minimum: 0
            maximum: 100
            description: "Completion percentage"

      # Artifact tracking for this instance
      artifacts:
        type: object
        properties:
          count:
            type: integer
            description: "Total artifacts created"

          committed:
            type: integer
            description: "Artifacts with COMMITTED status"

          stale:
            type: integer
            description: "Artifacts needing update"

          pending_decisions:
            type: integer
            description: "Decision Points awaiting input"

          list:
            type: array
            items:
              type: string
            description: "List of artifact dp_ids in this instance"

      # Runtime context
      context:
        type: object
        additionalProperties: true
        description: |
          Process-specific runtime context.
          Stores variables, user inputs, intermediate results
          that need to persist across sessions.

      # Resume information
      resume:
        type: object
        properties:
          can_resume:
            type: boolean
            description: "Whether instance can be resumed"

          resume_point:
            type: string
            description: "Where to resume from"

          blocked_by:
            type: array
            items:
              type: string
            description: "Decision Points blocking progress"

          notes:
            type: string
            description: "Notes for resumption"

# ============================================================================
# EXAMPLE REGISTRY
# ============================================================================

example:
  version: "3.6"
  created_at: "2025-01-30T10:00:00Z"
  last_modified: "2025-01-30T15:30:00Z"
  active_instance: "onboarding-client-acme-001"

  instances:
    - instance_id: "onboarding-client-acme-001"
      process_type: "PROC-ONBOARDING"
      process_path: "onboarding/"
      artifacts_path: "artifacts/processes/onboarding-client-acme-001/"
      status: "RUNNING"
      started_at: "2025-01-30T10:00:00Z"
      last_activity: "2025-01-30T15:30:00Z"
      progress:
        current_step: "step-03-requirements"
        steps_completed: ["step-01-intake", "step-02-analysis"]
        steps_remaining: ["step-03-requirements", "step-04-setup", "step-05-handoff"]
        percentage: 40
      artifacts:
        count: 5
        committed: 3
        stale: 1
        pending_decisions: 1
        list:
          - "INTAKE-ACME-001"
          - "ANALYSIS-ACME-001"
          - "DP-ACME-001"
      context:
        client_name: "ACME Corp"
        tier: "enterprise"
        contact_email: "contact@acme.com"
      resume:
        can_resume: true
        resume_point: "step-03-requirements"
        blocked_by: ["DP-ACME-001"]
        notes: "Awaiting decision on deployment model"

    - instance_id: "code-review-auth-feature-001"
      process_type: "PROC-CODE-REVIEW"
      process_path: "code-review/"
      artifacts_path: "artifacts/processes/code-review-auth-feature-001/"
      status: "COMPLETED"
      started_at: "2025-01-28T09:00:00Z"
      last_activity: "2025-01-28T16:00:00Z"
      completed_at: "2025-01-28T16:00:00Z"
      progress:
        current_step: null
        steps_completed: ["review", "feedback", "approval"]
        steps_remaining: []
        percentage: 100
      artifacts:
        count: 3
        committed: 3
        stale: 0
        pending_decisions: 0
        list:
          - "REVIEW-AUTH-001"
          - "FEEDBACK-AUTH-001"
          - "APPROVAL-AUTH-001"
      resume:
        can_resume: false

# ============================================================================
# OPERATIONS
# ============================================================================

operations:
  create_instance:
    description: "Create new process instance"
    steps:
      - "Generate unique instance_id"
      - "Create artifacts directory: artifacts/processes/{instance_id}/"
      - "Add entry to registry.json"
      - "Initialize instance-state.json in artifacts directory"
      - "Set status to PENDING or RUNNING"

  resume_instance:
    description: "Resume paused or blocked instance"
    steps:
      - "Load instance from registry"
      - "Check resume.can_resume"
      - "If blocked_by, check if Decision Points resolved"
      - "Set as active_instance"
      - "Load context"
      - "Continue from resume_point"

  switch_instance:
    description: "Switch active instance"
    steps:
      - "Save current instance state"
      - "Update active_instance in registry"
      - "Load new instance context"
      - "Display status of new instance"

  complete_instance:
    description: "Mark instance as completed"
    steps:
      - "Verify all steps completed"
      - "Verify no pending Decision Points"
      - "Set status to COMPLETED"
      - "Set completed_at"
      - "Optionally archive"
