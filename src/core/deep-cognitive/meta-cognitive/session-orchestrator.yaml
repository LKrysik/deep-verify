# Deep Cognitive — Session Orchestrator
# Version: 0.1 (PoC)
# Purpose: Manage session flow and state transitions

version: "0.1"

# ═══════════════════════════════════════════════════════════════
# SESSION LIFECYCLE
# ═══════════════════════════════════════════════════════════════

lifecycle:
  on_session_start:
    steps:
      - action: load_state
        source: ".deep/project-state.yaml"
        on_missing: prompt_init

      - action: check_blocking_items
        if_found:
          priority: critical
          present: blocking_summary

      - action: check_pending_tasks
        if_found:
          present: task_summary

      - action: run_planner
        output: recommendation

      - action: present_dashboard
        include:
          - current_phase
          - phase_progress
          - blocking_items
          - recommendation

    dashboard_template: |
      ╔═══════════════════════════════════════════════════════════════════════════╗
      ║  PROJECT: {project.name}                                                  ║
      ╠═══════════════════════════════════════════════════════════════════════════╣
      ║                                                                           ║
      ║  PHASE: {current.phase}                    Progress: {progress_bar}       ║
      ║                                                                           ║
      ║  ┌─────────────────────────────────────────────────────────────────────┐  ║
      ║  │  IDEA ──► SPEC ──► ARCH ──► IMPL ──► TEST ──► DONE                 │  ║
      ║  │  {phase_indicators}                                                 │  ║
      ║  └─────────────────────────────────────────────────────────────────────┘  ║
      ║                                                                           ║
      ║  {blocking_section}                                                       ║
      ║                                                                           ║
      ║  RECOMMENDED: {recommendation.message}                                    ║
      ║  Reason: {recommendation.reason}                                          ║
      ║                                                                           ║
      ╚═══════════════════════════════════════════════════════════════════════════╝

  on_operation_start:
    steps:
      - action: create_trace_entry
        fields:
          - operation_name
          - started_at
          - agent_id
          - input_context

      - action: snapshot_working_memory
        target: ".deep/agents/{agent_id}.yaml"

      - action: log_operation
        to: ".deep/traces/{date}-session.yaml"

  on_operation_complete:
    steps:
      - action: update_project_state
        updates:
          - metrics.total_operations +1
          - current.phase_progress (if changed)

      - action: update_working_memory
        target: ".deep/agents/{agent_id}.yaml"
        fields:
          - current_focus
          - progress
          - tentative_conclusions

      - action: append_trace
        to: ".deep/traces/{date}-session.yaml"
        data:
          - operation_name
          - duration
          - outputs
          - unknowns_discovered

      - action: run_unknown_detector
        scope: current_phase
        on_discovery:
          add_to: unknowns.to_explore
          notify: user

      - action: check_gate_readiness
        if_ready:
          suggest: deep-verify

      - action: run_planner
        output: next_recommendation

      - action: present_status
        include:
          - operation_result
          - unknowns_found
          - next_recommendation

  on_decision_made:
    steps:
      - action: create_decision_record
        template: ".deep/decisions/ADR-template.yaml"
        output: "docs/decisions/ADR-{sequence}.yaml"

      - action: update_project_state
        updates:
          - metrics.decisions_made +1
          - phases.{current_phase}.decisions_made append

      - action: unblock_dependent_tasks
        check: current.blocking_items
        unblock_where: decision_id matches

      - action: run_planner
        output: next_recommendation

  on_gate_check:
    steps:
      - action: run_verification
        operation: deep-verify
        target: "{gate_name}"
        output: verification_result

      - action: update_gate_status
        if_passed:
          - set: verification_gates[{gate}].status = "passed"
          - set: verification_gates[{gate}].score = {score}
          - set: verification_gates[{gate}].passed_at = {timestamp}
          - advance_phase: true

        if_failed:
          - set: verification_gates[{gate}].status = "failed"
          - set: verification_gates[{gate}].score = {score}
          - add_blocking_item:
              type: gate_failure
              gate: "{gate_name}"
              gaps: "{identified_gaps}"

      - action: present_gate_result
        template: gate_result_template

  on_session_end:
    steps:
      - action: save_all_working_memories
        target: ".deep/agents/*.yaml"

      - action: update_episodic_memory
        target: ".deep/memory/episodic.yaml"
        append:
          - session_date
          - operations_performed
          - decisions_made
          - phase_change (if any)

      - action: finalize_trace
        target: ".deep/traces/{date}-session.yaml"
        add:
          - session_end_time
          - total_duration
          - outcome_summary

      - action: generate_session_summary
        include:
          - operations_count
          - decisions_made
          - unknowns_discovered
          - phase_progress_delta
          - next_session_recommendations

      - action: present_summary
        template: session_summary_template

# ═══════════════════════════════════════════════════════════════
# DISPLAY TEMPLATES
# ═══════════════════════════════════════════════════════════════

templates:
  gate_result_passed: |
    ╔═══════════════════════════════════════════════════════════════════════════╗
    ║  ✓ GATE PASSED: {gate_name}                                               ║
    ╠═══════════════════════════════════════════════════════════════════════════╣
    ║                                                                           ║
    ║  Score: {score} (threshold: {threshold})                                  ║
    ║                                                                           ║
    ║  ADVANCING TO: {next_phase}                                               ║
    ║                                                                           ║
    ║  Next recommended operation: {next_operation}                             ║
    ║                                                                           ║
    ╚═══════════════════════════════════════════════════════════════════════════╝

  gate_result_failed: |
    ╔═══════════════════════════════════════════════════════════════════════════╗
    ║  ✗ GATE FAILED: {gate_name}                                               ║
    ╠═══════════════════════════════════════════════════════════════════════════╣
    ║                                                                           ║
    ║  Score: {score} (threshold: {threshold})                                  ║
    ║                                                                           ║
    ║  GAPS IDENTIFIED:                                                         ║
    {gaps_list}
    ║                                                                           ║
    ║  RECOMMENDED: {remediation_operation}                                     ║
    ║                                                                           ║
    ╚═══════════════════════════════════════════════════════════════════════════╝

  session_summary: |
    ╔═══════════════════════════════════════════════════════════════════════════╗
    ║  SESSION SUMMARY                                                          ║
    ╠═══════════════════════════════════════════════════════════════════════════╣
    ║                                                                           ║
    ║  Duration: {duration}                                                     ║
    ║  Operations: {operations_count}                                           ║
    ║  Decisions made: {decisions_made}                                         ║
    ║  Unknowns discovered: {unknowns_discovered}                               ║
    ║                                                                           ║
    ║  Phase at start: {phase_start}                                            ║
    ║  Phase at end: {phase_end}                                                ║
    ║  Progress delta: {progress_delta}                                         ║
    ║                                                                           ║
    ║  NEXT SESSION SHOULD:                                                     ║
    {next_session_recommendations}
    ║                                                                           ║
    ╚═══════════════════════════════════════════════════════════════════════════╝

  unknown_discovered: |
    ╔═══════════════════════════════════════════════════════════════════════════╗
    ║  ⚠ UNKNOWN DISCOVERED                                                      ║
    ╠═══════════════════════════════════════════════════════════════════════════╣
    ║                                                                           ║
    ║  {unknown.description}                                                    ║
    ║                                                                           ║
    ║  Type: {unknown.type}                                                     ║
    ║  Priority: {unknown.priority}                                             ║
    ║                                                                           ║
    ║  Impact if unaddressed: {unknown.impact}                                  ║
    ║                                                                           ║
    ║  Suggested action: {unknown.suggested_action}                             ║
    ║                                                                           ║
    ╚═══════════════════════════════════════════════════════════════════════════╝

# ═══════════════════════════════════════════════════════════════
# ERROR HANDLING
# ═══════════════════════════════════════════════════════════════

error_handling:
  on_state_corruption:
    - action: attempt_recovery
      from: ".deep/traces/{latest}"
    - action: notify_user
      message: "State file corrupted. Attempting recovery from trace."

  on_operation_failure:
    - action: rollback_working_memory
      to: last_snapshot
    - action: log_failure
      to: trace
    - action: suggest_recovery
      options:
        - "Retry operation"
        - "Skip and continue"
        - "Manual intervention"

  on_conflict:
    - action: detect_conflict
      source: agent_updates
    - action: present_conflict
      to: user
    - action: await_resolution
      options:
        - "Accept agent A's version"
        - "Accept agent B's version"
        - "Merge manually"
